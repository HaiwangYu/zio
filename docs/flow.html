<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-12-29 Sun 12:02 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ZIO data flow</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Brett Viren" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="org.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="."> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content">
<h1 class="title">ZIO data flow</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org97a7068">1. API</a></li>
<li><a href="#orge920552">2. Flow protocol</a></li>
<li><a href="#org3dac784">3. Flow messages</a></li>
<li><a href="#orgbf27944">4. Flow API</a></li>
<li><a href="#orgc1fceb4">5. Extending Flow API</a></li>
</ul>
</div>
</div>
<div class="nav">
<ul class="org-ul">
<li><a href="index.html">Main Page</a></li>
<li><a href="tutorial.html">Tutorial</a></li>
<li><a href="howtos.html">How-to guides</a></li>
<li><a href="whytos.html">Why-to descriptions</a></li>
<li><a href="api.html">API Reference</a></li>
</ul>

</div>

<p>
ZIO <i>data flow protocol</i> supports one-way transmission of
application-dependent payload messages between two ports with
additional guarantees beyond those that are provided by ZIO ports in
general.  These guarantees include:
</p>

<ul class="org-ul">
<li>The endpoints use only the ZeroMQ socket types CLIENT or SERVER.</li>

<li>For any given transmission, the payload message flow may proceed in
one direction only (CLIENT to SERVER or vice versa).</li>

<li>The total number of messages buffered by the sockets at both
endpoints combined will not exceed a given maximum.</li>

<li>The client side may be safely used in an execution context serviced
by different threads at different points in time.  The server side
is guaranteed only if it executes fully in one thread (although
usual ZeroMQ inter-thread communication is allowed).</li>
</ul>

<p>
The benefits of these guarantees (some might call them restrictions or
limitations) are described in the section of the ZeroMQ guide covering
<a href="http://zguide.zeromq.org/page:all#toc211">credit-based flow control</a>.
</p>

<div id="outline-container-org97a7068" class="outline-2">
<h2 id="org97a7068"><span class="section-number-2">1</span> API</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">
<pre class="src src-c++"><span style="color: #73d216;">// </span><span style="color: #73d216;">t.b.d</span>
<span style="color: #73d216;">// </span><span style="color: #73d216;">client</span>
cl.send()
cl.recv()
<span style="color: #73d216;">// </span><span style="color: #73d216;">server</span>
client (cl(s.recv()-&gt;spawn())
</pre>
</div>
</div>
</div>

<div id="outline-container-orge920552" class="outline-2">
<h2 id="orge920552"><span class="section-number-2">2</span> Flow protocol</h2>
<div class="outline-text-2" id="text-2">
<p>
The ZIO <i>data flow protocol</i> is partly illustrated in the UML sequence
diagram below.  It shows two phases: <i>initiate</i> and <i>transfer</i>.  In
<i>initiate</i> the client always sends to the server.  In <i>transfer</i> the
exchange depends on the parameters determined in the <i>initiate</i> phase.
</p>


<div class="figure">
<p><img src="flow-extract.png" alt="flow-extract.png" />
</p>
</div>

<p>
In <i>initate</i>, the client sends a begin-of-transmission (<code>BOT</code>) message and
the server responds with another <code>BOT</code>.  Either holds two required
values:
</p>

<ul class="org-ul">
<li>direction : the <i>direction</i> (see below) of the flow from the point of
view of the message sender.</li>

<li>credits : the number of credits to use</li>
</ul>

<p>
The <i>direction</i> is one of two values: <i>extract</i> means endpoint will send
payload data and <i>inject</i> means the endpoint expects to receive payload
data.
</p>

<p>
The server receives the client's <code>BOT</code> and in forming its reply <code>BOT</code>
shall reverse the <i>direction</i> field and may adjust<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup> the
number of credits downward.  The client receives the reply and shall
accept the number of credits.
</p>

<p>
Alternatively (and not shown in the diagram) the server may
immediately respond with end-of-transmission (<code>EOT</code>) if the request is
rejected.
</p>


<p>
The <i>transfer</i> state is then entered.  It will proceed in one of the two
possible flow <i>direction</i> and these two variants are a mirror symmetry
of each other (with respect to exchange of client and server).  If the
client <code>BOT</code> specifies the <i>extract</i> direction then the client side is
<i>sender</i> of payload messages, else it is the server side.  The end which
is not the <i>sender</i> is the <i>recver</i>.  These describe the direction of <code>DAT</code>
messages and <code>PAY</code> messages are sent in the opposite direction (<i>sender</i>
receives <code>PAY</code>).  Like <code>BOT</code>, <code>EOT</code> travel both directions.
</p>

<p>
Regardless of the <i>direction</i> the <i>transfer</i> starts out by the <i>recver</i>
sending a number of credits in a <code>PAY</code> message and decrementing the
number of held credits by an equal amount.  The <i>recver</i> may send
subsequent <code>PAY</code> messages anytime it posses credit and may send any
amount up to and including the amount currently held.  A <i>recver</i> credit
is replenished one unit for every <code>DAT</code> message received.
</p>

<p>
The <i>sender</i> may send payload <code>DAT</code> message at any time it has credit.
Each <code>DAT</code> message depletes the credit held by the <i>sender</i> by one unit
and each <code>PAY</code> replenishes credit in the amount indicated in the
message.
</p>

<p>
At any point in time, either endpoint may explicitly terminate the
transmission by sending an <code>EOT</code>.  If <code>EOT</code> is received, an endpoint shall
acknowledge the termination by echoing back an <code>EOT</code>.  In the
illustration, the client initiates termination.  This <code>EOT</code> is sent
quickly after two <code>DAT</code> messages for which the server has yet to
respond.  Thus, the client will receive subsequent <code>PAY</code> messages prior
to the <code>EOT</code> acknowledgment.  In order to assure all buffers on both
ends are flushed, it is important for the issuer of an EOT to continue
receiving until that <code>EOT</code> acknowledgment arrives and give a chance for
the application to process any <code>DAT</code> that may have arrived, if the
endpoint is a <i>recver</i>.
</p>

<p>
In real world applications the protocol may be interrupted at any
time.  It provides no in-band support for handling interruptions other
than what may be provided by ZeroMQ.  Using finite timeout with ZIO
flow protocol an application may consult a ZIO <code>peer</code> to determine if
the other end is still online or not.
</p>
</div>
</div>

<div id="outline-container-org3dac784" class="outline-2">
<h2 id="org3dac784"><span class="section-number-2">3</span> Flow messages</h2>
<div class="outline-text-2" id="text-3">
<p>
ZIO data flow introduces a new ZIO message of type <code>FLOW</code>.  This message
type has no meaningful "level" and so it is set to undefined (0).  The
payload frames of a <code>FLOW</code> message are unused by the ZIO <i>data flow</i>
protocol and are available for application use.  The protocol is
implemented using the <code>label</code> field of the ZIO message prefix header.
This field shall hold a string representing a JSON object which is
here called the <i>flow object</i>.  
</p>

<p>
A <i>flow object</i> shall always have an attribute named <code>flow</code> the value of
which defines a (sub) message type in the <i>data flow</i> protocol.  Any
<code>FLOW</code> message lacking this attribute may be dropped.  The <code>flow</code>
attribute may hold a value of: <code>BOT</code>, <code>EOT</code>, <code>DAT</code> or <code>PAY</code>.  Depending on the
value, additional attributes may be required or optional.  The meaning
of these (sub) message types and their associated attributes are
described:
</p>

<dl class="org-dl">
<dt><code>BOT</code></dt><dd>begin-of-transmission, client sends with <code>direction</code> set to
<code>extract</code> or <code>inject</code>, server sends with <code>credits</code> set to an integer.  <code>BOT</code>
explicitly extends initial credit.</dd>

<dt><code>EOT</code></dt><dd>end-of-transmission, either side may send, receiver should
echo back.  No associated attributes.</dd>

<dt><code>PAY</code></dt><dd>credit is extended from one endpoint to another as given in
the <code>credit</code> attribute with a whole number value.</dd>

<dt><code>DAT</code></dt><dd>the message payload holds an application specific encoded
message and no additional attribute is associated.</dd>
</dl>

<p>
The application may augment the <i>flow object</i> with additional attributes
and is free to fill the payload frame or frames of any <code>FLOW</code> message.
</p>
</div>
</div>

<div id="outline-container-orgbf27944" class="outline-2">
<h2 id="orgbf27944"><span class="section-number-2">4</span> Flow API</h2>
<div class="outline-text-2" id="text-4">
<p>
ZIO provides an API to simply participating in a ZIO <i>data flow
protocol</i>.  The central API class is <code>zio::flow::Flow</code> which may be used
by both <i>sender</i> and <i>recver</i> clients as well as part of a handler inside
a multi-client server.  The following UML sequence diagram illustrates
the possible interactions between a <code>Flow</code> object, its port and the
application which owns it.
</p>


<div class="figure">
<p><img src="flow-credit.png" alt="flow-credit.png" />
</p>
</div>

<p>
A <code>Flow</code> is created on a <code>port</code> by an application.  The <code>port</code> should
already be online.  A <code>Flow</code> is created with a <code>BOT</code> which is then sent
out the port and the <code>Flow</code> will wait for a <code>BOT</code> (or <code>EOT</code>) response.
Based on the <code>BOT</code> <i>direction</i> it will enter either <i>sender</i> or <i>recver</i> mode.
As described above, the <code>BOT</code> direction is from the point of view of the
source of the <code>BOT</code> message and so for example a <code>Flow</code> will be <i>sender</i> if
the <code>BOT</code> indicates the other endpoint wants direction <i>inject</i>.
</p>

<p>
Depending on the mode, the application may then call synchronous the
methods <code>put()</code> (<i>sender</i> mode) or <code>get()</code> (<i>recver</i> mode).  Proper mode
operation may be asserted.  During their calls, asynchronous
communication with the port proceeds and both may <code>recv()</code> messages from
the port.  If a <code>recv()</code> returns and <code>EOT</code> (instead of the expected <code>PAY</code> or
<code>DAT</code>) these methods return <code>false</code>.  The application should check this
return and call <code>eot()</code>, possibly with a zero timeout, to issue a reply.
</p>

<p>
Such an <code>EOT</code> would arise because either mode on either end may call
<code>eot()</code> at any time.  When so initiated by the application, the timeout
should be non-zero to avoid loss of any messages still buffered in the
sockets.  If an <code>EOT</code> reply is received, this method returns <code>true</code>.  A
number of <code>PAY</code> (if <i>sender</i>) or <code>DAT</code> (if <i>recver</i>) messages may arrive
before the reply-<code>EOT</code> and they shall be discarded.
</p>

<p>
The <code>Flow</code> class is designed to be used both as the core of a ZIO flow
client and also as a client <i>handler</i> inside a multi-client ZIO flow
server.  In order to achieve this symmetry, the server implementation
must perform a minor sleight-of-hand.  This is illustrated in the
following UML sequence diagram.
</p>


<div class="figure">
<p><img src="flow-server-credit.png" alt="flow-server-credit.png" />
</p>
</div>

<p>
In the illustration, the server listens on its own server port (a
SERVER socket) for <code>FLOW</code> messages coming from a Flow clients.  When a
<code>BOT</code> is received from new client a local <i>handler</i> is constructed via a
factory.  This handler executes as an actor (ZeroMQ <code>zactor_t</code>).
Internally, it operates exactly like shown in the ZIO Flow API
Sequence diagram except the <code>zio::flow::Flow</code> is constructed around a
<code>port</code> that wraps the PAIR socket of the actor pipe.  The other end of
that pipe is held by the factory.  
</p>

<p>
This is the first sleight-of-hand the server must do.  The second is
in handling the <code>BOT</code> messages.  The <i>direction</i> of the <code>BOT</code> from the
remote client must be reversed prior to being used in constructing the
handler as it tells the handler the direction it should operate in.
This reversed direction is labeled in the diagram as <code>BOT'</code>.  The
handler is following the Flow API sequence diagramed above so simply
sends out this <code>BOT'</code> as if it were a remote client.  To uphold that
fiction, the server must reverse yet again and send the final <code>BOT'</code>.
</p>

<p>
Thus, the flow server code acts as a proxy between a remote client and
its handler.  The server is templated on the factory and so it is the
factory which ultimately determins the specific behavior of the
server.  The constructed handlers are also application dependent code
but may use <code>zio::flow::Flow</code> exactly as a client would.  This means
that the cartesian product of (server, client) \(\times\) (<i>sender</i>,
<i>recver</i>) does not have to result in four separate implementations and
all implementations can reuse the server and the <code>Flow</code> code.
</p>
</div>
</div>

<div id="outline-container-orgc1fceb4" class="outline-2">
<h2 id="orgc1fceb4"><span class="section-number-2">5</span> Extending Flow API</h2>
<div class="outline-text-2" id="text-5">
<p>
As described in the section above on Flow messages, the payload and
header leable object attributes are in <code>FLOW</code> messages are available for
the application to use.  In particular, the <code>BOT</code>, <code>DAT</code> and <code>EOT</code> messages
(but not <code>PAY</code>) enter application code on both ends.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
The number credits likely will be selected to limit
memory usage on the server as it may be servicing multiple clients on
multiple remote hosts.
</p></div></div>


</div>
</div></div>
</body>
</html>
